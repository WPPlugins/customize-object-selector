wp.customize.ObjectSelectorComponent=function(a,b){"use strict";return a.Class.extend({nonce:"",l10n:{missing_model_arg:"",failed_to_fetch_selections:"",add_new_buttons_customize_posts_dependency:""},initialize:function(b){var c=this;if(!b.model||"function"!=typeof b.model.get)throw new Error(c.l10n.missing_model_arg);c.model=b.model,c.containing_construct=b.containing_construct||null,c.select2_options={cache:!1,width:"100%",multiple:!1},b.select2_options&&(c.select2_options=b.select2_options),c.container=b.container,c.post_query_vars=null,c.show_add_buttons=!!_.isUndefined(b.show_add_buttons)||b.show_add_buttons,!c.show_add_buttons||a.Posts&&_.isFunction(a.Posts.startCreatePostFlow)||("undefined"!=typeof console&&_.isFunction(console.warn)&&a.Section&&console.info(c.l10n.add_new_buttons_customize_posts_dependency),c.show_add_buttons=!1),c.select_id=b.select_id||"",c.control_template=b.control_template||wp.template("customize-object-selector-component"),c.select2_result_template=b.select2_result_template||wp.template("customize-object-selector-item"),c.select2_selection_template=b.select2_selection_template||wp.template("customize-object-selector-item"),b.post_query_vars&&(c.post_query_vars=b.post_query_vars)},embed:function(c){var d,e=this;e.container=c,d={multiple:e.multiple,select_id:e.select_id,addable_post_types:e.show_add_buttons?e.getAddableQueriedPostTypes():[]},e.container.empty().append(e.control_template(d)),e.select=e.container.find("select:first"),e.select.select2(_.extend({ajax:{transport:function(a,b,c){var d=e.queryPosts({s:a.data.term,paged:a.data.page||1});return d.done(b),d.fail(function(a,b){"abort"===b&&(d.status="0"),c.apply(d,arguments)}),d}},templateResult:function(a){return b.trim(e.select2_result_template(a))},templateSelection:function(a){return a.multiple=e.select2_options.multiple,b.trim(e.select2_selection_template(a))},escapeMarkup:function(a){return a}},e.select2_options,{disabled:!0})),e.populateSelectOptions().done(function(){e.select.prop("disabled",!1)}),e.select.on("change",function(){e.setSettingValues(_.map(e.getSelectedValues(),function(a){return parseInt(a,10)}))}),e.model.bind(function(){e.populateSelectOptions(!1)}),e.setupSortable(),a.Posts&&_.isFunction(a.Posts.startCreatePostFlow)&&(e.setupAddNewButtons(),e.setupEditLinks()),e.repopulateSelectOptionsForSettingChange=_.bind(e.repopulateSelectOptionsForSettingChange,e),a.bind("change",e.repopulateSelectOptionsForSettingChange)},repopulateSelectOptionsForSettingChange:function(a){var c,d,e=this,f=e.getSettingValues();d=a.id.match(/^post\[[^\]]+]\[(\d+)]/),d&&(c=parseInt(d[1],10),(_.isArray(f)?-1!==b.inArray(c,f):c===f)&&e.populateSelectOptions(!0))},getQueryPostTypes:function(){var b,c=this;return a.Posts&&a.Posts.data.postTypes?b=c.post_query_vars&&c.post_query_vars.post_type?_.isArray(c.post_query_vars.post_type)?c.post_query_vars.post_type:c.post_query_vars.post_type.split(/,/):["post"]:[]},getAddableQueriedPostTypes:function(){var b,c,d=this;return b=d.getQueryPostTypes(),b=_.filter(b,function(b){var c=a.Posts.data.postTypes[b];return!_.isUndefined(c)&&(c.show_in_customizer&&c.current_user_can.create_posts)}),c=[],_.each(b,function(d){var e,f=a.Posts.data.postTypes[d];e=b.length>1?f.labels.add_new_item||f.labels.add_new:f.labels.add_new||f.labels.add_new_item,c.push(_.extend({post_type:d,add_button_label:e},f))}),c},queryPosts:function(b){var c,d,e=this,f={};return c="customize_object_selector_query",d={customize_object_selector_query_nonce:e.nonce},a.previewer&&a.previewer.query&&_.extend(d,a.previewer.query()),a.settings&&a.settings.nonce&&a.settings.nonce[c]&&(d.customize_object_selector_query_nonce=a.settings.nonce[c]),_.extend(f,e.post_query_vars||{},b||{}),d.post_query_args=JSON.stringify(f),wp.ajax.post(c,d)},getSelectedValues:function(){var a,b=this;return a=b.select.val(),_.isEmpty(a)?a=[]:_.isArray(a)||(a=[a]),_.map(a,function(a){return parseInt(a,10)})},getSettingValues:function(){var a,b,c=this;return a=c.model.get(),_.isArray(a)||(b=[],_.isNumber(a)?b.push(a):_.isString(a)&&_.each(a.split(/\s*,\s*/),function(a){var c=parseInt(a,10);!isNaN(c)&&c>0&&b.push(c)}),a=b),a},setSettingValues:function(a){var b=this;b.select2_options.multiple?b.model.set(a):b.model.set(a[0]||0)},setupSortable:function(){var a,c=this;c.select2_options.multiple&&(a=c.select.next(".select2-container").first("ul.select2-selection__rendered"),a.sortable({placeholder:"ui-state-highlight",forcePlaceholderSize:!0,items:"li:not(.select2-search__field)",tolerance:"pointer",stop:function(){var d=[];a.find(".select2-selection__choice").each(function(){var a,e;a=parseInt(b(this).data("data").id,10),d.push(a),e=c.select.find('option[value="'+a+'"]'),c.select.append(e)}),c.setSettingValues(d)}}))},setupAddNewButtons:function(){var c=this;c.container.on("click",".add-new-post-button",function(){var d=b(this);a.Posts.startCreatePostFlow({postType:b(this).data("postType"),initiatingButton:d,originatingConstruct:c.containing_construct,restorePreviousUrl:!0,returnToOriginatingConstruct:!0,breadcrumbReturnCallback:function(a){var b;"publish"===a.setting.get().post_status&&(b=c.getSettingValues().slice(0),c.select2_options.multiple?(c.select2_options.multiple&&c.select2_options.limit>=b.length&&(b.length=c.select2_options.limit-1),b.unshift(a.postId)):b=[a.postId],c.setSettingValues(b))}})})},setupEditLinks:function(){var c,d,e=this;c=e.container.find(".select2-selection__choice__edit"),d=function(a){var b=parseInt(a,10);c.toggle(!isNaN(b)&&0!==b&&!e.select2_options.multiple)},d(e.model.get()),e.model.bind(d),e.container.on("click",".select2-selection__choice__edit",function(c){var d,f=b(this);d=e.select2_options.multiple?f.data("postId"):parseInt(e.model.get(),10),c.preventDefault(),e.select.select2("close"),e.select.prop("disabled",!0),f.addClass("loading"),a.Posts.startEditPostFlow({postId:d,initiatingButton:f,originatingConstruct:e.containing_construct,restorePreviousUrl:!0,returnToOriginatingConstruct:!0,breadcrumbReturnCallback:function(){e.setSettingValues(e.getSettingValues().slice(0)),f.removeClass("loading"),e.select.prop("disabled",!1),e.containing_construct.focus()}})})},populateSelectOptions:function(c){var d,e,f=this,g=jQuery.Deferred();return d=f.getSettingValues(),e=f.getSelectedValues(),!c&&_.isEqual(e,d)?g.resolve():0===d.length||_.isEqual([0],d)?(f.select.empty(),f.select.trigger("change"),g.resolve()):(f.container.addClass("customize-object-selector-populating"),f.currentRequest&&f.currentRequest.abort(),f.currentRequest=f.queryPosts({post__in:d,orderby:"post__in"}),f.currentRequest.done(function(a){f.containing_construct&&f.containing_construct.notifications&&f.containing_construct.notifications.remove("select2_init_failure"),f.select.empty(),_.each(a.results,function(a){var c,e;c=-1!==b.inArray(a.id,d),e=new Option(f.select2_result_template(a),a.id,c,c),e.title=a.title,f.select.append(e)}),f.select.trigger("change"),g.resolve()}),f.currentRequest.fail(function(b,c,d){var e;"abort"!==c&&a.Notification&&f.containing_construct&&f.containing_construct.notifications&&(e=new a.Notification("select2_init_failure",{type:"error",message:f.l10n.failed_to_fetch_selections.replace("%s",d)}),f.containing_construct.notifications.add(e.code,e)),g.reject()}),f.currentRequest.always(function(){f.container.removeClass("customize-object-selector-populating")})),g.promise()},destroy:function(){var b=this;a.unbind("change",b.repopulateSelectOptionsForSettingChange),b.select&&b.select.data("select2")&&b.select.select2("close"),b.container&&b.container.empty()}})}(wp.customize,jQuery);